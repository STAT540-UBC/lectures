---
title: "Causal inference and confounding effects"
author: |
    | Yongjin Park
    | University of British Columbia
date: "`r format(Sys.time(), '%d %B, %Y')`"
classoption: "aspectratio=169"
output:
    powerpoint_presentation:
        reference_doc: "_template.pptx"
    html_document:
        self_contained: true
    beamer_presentation:
        colortheme: "orchid"
        keep_tex: true
        latex_engine: xelatex
        slide_level: 2
header-includes:
  - \usepackage{cancel}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \setbeamercolor{alerted text}{fg=magenta}
  - \AtBeginSection[]{\begin{frame}\frametitle{Today's lecture}\tableofcontents[currentsection]\end{frame}}
  - |
    \makeatletter
    \def\ps@titlepage{%
      \setbeamertemplate{footline}{}
    }
    \addtobeamertemplate{title page}{\thispagestyle{titlepage}}{}
    \makeatother
    \include{toc}
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(patchwork)
source("Util.R")
source("Setup.R")
fig.dir <- "Fig/causality/"
setup.env(fig.dir)
dir.create("Data", showWarnings=FALSE)
theme_set(theme_classic())
```

# Causal Inference based on a Graphical language

## A working example: confounder adjustment in case-control study

```{r example_1}
sim.example1 <- function(){
    set.seed(1)
    n <- 300; .tau <- 1; .eps <- .5
    sgm <- function(x) 1/(1+ exp(-x))
    cc <- matrix(rnorm(n*2), nrow=n, ncol=2)

    .delta <- matrix(c(1, 3), nrow=2, ncol=1)
    .beta <- matrix(c(-3, -1), nrow=2, ncol=1)
    .zeta <- matrix(c(-3, 2), nrow=2, ncol=1)

    xx <- sgm(cc %*% .delta + rnorm(n)) %>% rbinom(n=n, size=1)
    yy.true <- scale(xx * .tau) + rnorm(n) * sqrt(.eps)
    yy <- yy.true + cc %*% .beta
    mm <- cc %*% .zeta
    rr <- cc %*% .delta + yy + rnorm(n) * sqrt(.eps)

    .dt <- data.table(y = as.numeric(yy),
                      y.true = as.numeric(yy.true),
                      x = as.numeric(xx),
                      c1 = cc[,1], c2 = cc[,2],
                      M = as.numeric(mm),
                      R = as.numeric(rr))
}
```

```{r}
.dt <- sim.example1()
```

:::::: {.columns}
::: {.column width=.25}

```{r fig.width=1.8, fig.height=2.9}
ggplot(.dt, aes(as.factor(x), y, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("exposure/treatment") +
    ylab("outcome")
```

:::
::: {.column width=.25}

```{r fig.width=1.8, fig.height=3, only.plot="2"}
p1 <-
    ggplot(.dt, aes(c1, y, fill=as.factor(x))) +
    geom_point(pch=21, alpha=.5) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ylab("outcome")

p2 <-
    ggplot(.dt, aes(c2, y, fill=as.factor(x))) +
    geom_point(pch=21, alpha=.5) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ylab("outcome")

p1/p2
```

```{r fig.width=1.8, fig.height=3, only.plot="3"}
p1 <-
    ggplot(.dt, aes(M, y, fill=as.factor(x))) +
    geom_point(pch=21, alpha=.5) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ylab("outcome")

p2 <-
    ggplot(.dt, aes(R, y, fill=as.factor(x))) +
    geom_point(pch=21, alpha=.5) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ylab("outcome")

p1/p2
```

:::
::: {.column width=.4}

\Large

**Key question:** $X \overset{?}{\to} Y$

$\mathbf{\color{red} X}$: exposure variable 

$\mathbf{\color{blue} Y}$: outcome variable

\only<2->{

$\mathbf{\color{teal} C_{1}}$ and $\mathbf{\color{teal} C_{2}}$: covariates 

}

\only<3>{

$\mathbf{\color{pink} M}$: other covariate

$\mathbf{\color{magenta} R}$: other covariate

}

:::
::::::


## Causal inference with a graphical model

:::::: {.columns}
::: {.column width=.35}

\begin{enumerate}
\item<1-> Build a causal structural model
\item<2-> Identify "back-door" paths/variables (\textit{\color{magenta} closing $Y \to X$}, \textit{\color{teal} while opening $X \to Y$})
\item<5-> Adjust "back-door" variables
\item<5> Estimate causal effects
\end{enumerate}


```{r fig.width=2, fig.height = 1.5, only.plot="5"}
.dt[, y.resid := residuals(lm(`y` ~ `c1` + `c2`))]
ggplot(.dt, aes(as.factor(x), y, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("exposure/treatment") +
    ylab("outcome")
```

:::
::: {.column width=.6}

```{r fig.width=1.5, fig.height=3, results="asis", only.plot="1"}
knitr::include_graphics("example/example_dag1_open.pdf")
```

\only<1>{
\large
\centerline{What are potential backdoors?}
}

```{r fig.width=1.5, fig.height=3, results="asis", only.plot="2"}
knitr::include_graphics("example/example_dag1_open_bd.pdf")
```

\only<2>{
\large
\centerline{How do we close them?}
}

```{r fig.width=1.5, fig.height=3, results="asis", only.plot="3"}
knitr::include_graphics("example/example_dag1_open_bd_wrong.pdf")
```

\only<3>{
\large
\centerline{What about this?}
}

```{r fig.width=1.5, fig.height=3, results="asis", only.plot="4"}
knitr::include_graphics("example/example_dag1.pdf")
```

\only<4>{
\large
\centerline{Is this enough?}
}

\only<5>{
\begin{eqnarray*}
Y \gets Y - \sum_{k=1}^{2} C_{k} \hat\beta_{k}
\end{eqnarray*}
which approximates
\begin{eqnarray*}
p(Y|X) = \int_{C} p(Y|X,C) p(C) dC
\end{eqnarray*}
}

```{r fig.width=2, fig.height = 1.5, only.plot="5"}
ggplot(.dt, aes(as.factor(x), y.resid, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("exposure/treatment") +
    ylab("adjusted\noutcome")
```

:::
::::::


## What would happen if we close a wrong "backdoor" variable?

```{r}
.dt[, y.resid.m := residuals(lm(`y` ~ `M`))]
.dt[, y.resid.r := residuals(lm(`y` ~ `R`))]
```

:::::: {.columns}
::: {.column width=.45}

Adjusting $Y$ by the backdoor $C$

```{r fig.width=2.5, fig.height=2}
ggplot(.dt, aes(as.factor(x), y.resid, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("exposure/treatment") +
    ylab("outcome\nadjusted\nby confounder")
```

:::
::: {.column width=.45}

\only<1>{
Adjusting $Y$ by the invalid $M$
}
```{r fig.width=2.5, fig.height=2, only.plot="1"}
ggplot(.dt, aes(as.factor(x), y.resid.m, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("exposure/treatment") +
    ylab("outcome\nadjusted\nby M")
```

\only<2>{
Adjusting $Y$ by the collider $R$
}
```{r fig.width=2.5, fig.height=2, only.plot="2"}
ggplot(.dt, aes(as.factor(x), y.resid.r, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("exposure/treatment") +
    ylab("outcome\nadjusted\nby R")
```

:::
::::::


# Inverse Propensity Weighting

## Inverse Propensity Weighting

What is the model for $X$ given confoudners (the backdoor variables)?

```{r}
.dt[, x := factor(x, c(0, 1), c("0", "1"))]
.dt[, e.hat := predict(glm(`x` ~ `c1` + `c2`, family="binomial"))]
.dt[, e.hat := 1/(1+exp(-e.hat))]
```

Propensity = probability of assignment $X=1$:

$$p(X|C_{1}, C_{2}) \approx \frac{1}{1 + \exp(- \beta_{0} - \beta_{1} C_{1} - \beta_{2} C_{2} )}$$

\vfill

```{r fig.width=5, fig.height=1.8, only.plot="1"}
p1 <- ggplot(.dt, aes(c1, e.hat)) + geom_point() + ylab("p(X|C)")
p2 <- ggplot(.dt, aes(c2, e.hat)) + geom_point() + ylab("p(X|C)")
p1 | p2
```

```{r fig.width=5, fig.height=1.8, only.plot="2"}
p1 <- ggplot(.dt, aes(c1, e.hat, fill=x)) + geom_point(pch=21, alpha=.5) + ylab("p(X|C)") + scale_fill_manual(values=c("gray80", "orange")) + theme(legend.position="none")
p2 <- ggplot(.dt, aes(c2, e.hat, fill=x)) + geom_point(pch=21, alpha=.5) + ylab("p(X|C)") + scale_fill_manual(values=c("gray80", "orange")) + theme(legend.position=c(.9,.1), legend.justification=c(1,0))
p1 | p2
```

\vfill

Horvitz and Thomson, *JASA*, 1952

## Intuition behind IPW 

\Large

What if we have assigned $X=1$ unconfounded by $C$?

\onslide<2->{
In other words, what if samples could be drawn more from the underrepresented group?
}

\onslide<3>{
Likewise, what if samples could be dropped in the overrepresented group?
}

## Inverse Propensity Weighting "inverse" confounded assignment

```{r}
y <- .dt$y
x <- as.numeric(as.character(.dt$x))
cc <- cbind(.dt$c1, .dt$c2)
```

:::::: {.columns}
::: {.column width=.38}

$$\hat{Y}_{i}^{(1)} = \frac{X_{i} Y_{i}}{\hat{p}(X_{i}=1|C_{i})}$$

$$\hat{Y}_{i}^{(0)} = \frac{(1-X_{i}) Y_{i}}{1 - \hat{p}(X_{i}=1|C_{i})}$$

\only<2>{
equivalently give weights for $\forall$ i
$$
W_{i} \propto \left\{ \begin{array}{l l}
1/p(X_{i}=1|C_{i}) & X_{i} = 1\\
1/p(X_{i}=0|C_{i}) & X_{i} = 0\\
\end{array}
\right.
$$
}

:::
::: {.column width=.58}

```{r}
sigmoid <- function(x) 1/(1+exp(-x))
clamp <- function(x, lb = .1, ub = .9)
    pmin(pmax(x, lb), ub)
```

```{r echo=TRUE, size="large"}
p.xc <-
    glm(x~cc, family="binomial") %>%
    predict() %>%
    sigmoid() %>%
    clamp() # avoid 0 or 1

ww <- x / p.xc + (1-x) / (1-p.xc)
```

:::
::::::

## Take samples inversely proportional to propensity

```{r fig.width=4, fig.height=2.5, only.plot="1"}
.df <- tibble(y, x, ww) %>% 
    mutate(x = factor(x, c(0,1), c("0", "1")))
ggplot(.df, aes(x,y)) +
    geom_jitter(height=0, width=.1, color="gray40")
```

```{r fig.width=5, fig.height=2.5, only.plot="2"}
ggplot(.df, aes(x,y,size=ww)) +
    geom_jitter(height=0, width=.1, alpha=.5) +
    scale_size_continuous("W", range=c(0,5))
```

```{r fig.width=6, fig.height=2.5, only.plot="3"}
.idx <- sample(1:nrow(.df), 300, replace=TRUE, prob = .df$ww)
.df.bootstrap <- .df[.idx, ]
p1 <-
    ggplot(.df, aes(x,y,fill=x,group=x)) +
    geom_violin(alpha=.5) +
    ylab("observed outcome") +
    scale_fill_manual(values=c("gray80", "orange"), guide="none") +
    ggpubr::stat_compare_means(vjust=1, hjust=0, size=2, color="red") +
    geom_jitter(height=0, width=.1, color="gray40", size=1, stroke=0)
p2 <-
    ggplot(.df.bootstrap, aes(x,y,fill=x,group=x)) +
    geom_violin(alpha=.5) +
    ylab("resampled by IPW") +
    scale_fill_manual(values=c("gray80", "orange"), guide="none") +
    ggpubr::stat_compare_means(vjust=1, hjust=0, size=2, color="red") +
    geom_jitter(height=0, width=.1, color="gray40", size=1, stroke=0)
p1 | p2
```

\onslide<2->{
$$
W_{i} \propto \left\{ \begin{array}{l l}
1/p(X_{i}=1|C_{i}) & X_{i} = 1\\
1/p(X_{i}=0|C_{i}) & X_{i} = 0\\
\end{array}
\right.
$$
}

## Why IPW works? Unbiased estimate potential outcome

Letting $e(z) = \hat{p}(X=1|C=z)$, 

\Large 

we can prove $\mathbb{E}\!\left[XY/e(X)\right] \to \mathbb{E}\!\left[Y^{(1)}\right]$

using

* Strong ignorability

* Smoothness

* Stable Unit Treatment (exposure) Variable

## Why IPW works? Unbiased estimate potential outcome

Letting $e(z) = \hat{p}(X=1|C=z)$, 
\begin{eqnarray*}
\mathbb{E}\!\left[\frac{X_{i}Y_{i}}{e(C_{i})}\right]
&=& 
\onslide<2->{
\mathbb{E}\!\left[
\mathbb{E}\!\left[ \frac{X_{i}Y_{i}}{e(C_{i})} \middle| C_{i} \right]
\right] \quad \textsf{\color{gray} (law of total expectation)}\\
}
\onslide<3->{
\textsf{\color{pink} (C is sufficient backdoor)}
&=&
\mathbb{E}\!\left[
\mathbb{E}\!\left[ \frac{X_{i}Y_{i}^{(1)}}{e(C_{i})} \middle| C_{i} \right]
\right] \\
}
\onslide<4->{
\textsf{\color{magenta} (strong ignorability)}
&=&
\mathbb{E}\!\left[Y_{i}^{(1)}
\mathbb{E}\!\left[ \frac{X_{i}}{e(C_{i})} \middle| C_{i} \right]
 \right] \quad {\color{magenta} Y^{(1)} \perp\!\!\perp X | C} \\
}
\onslide<5->{
\textsf{\color{teal} (smoothness)}
&=&
\mathbb{E}\!\left[Y_{i}^{(1)}
\frac{1}{\cancel{e(C_{i})}}
\cancel{\mathbb{E}\!\left[ X_{i} \middle| C_{i} \right]}
 \right] \quad {\color{teal} 0 < e(C) < 1} \\
}
\onslide<6>{
&=& \mathbb{E}\!\left[Y^{(1)}\right]
}
\end{eqnarray*}

## When do we use IPW to estimate potential outcomes?

\Large

\begin{itemize}[<+-| alert@+>]
\item Backdoor variables are sufficiently characterized
\item We have an unbiased way to estimate the propensity model
\item Smooth overlap $1 > e(X) > 0$
\end{itemize}

# Potential outcome

## Estimating potential outcome by matching

```{r fig.width=2, fig.height=3, results="asis", only.plot="1"}
knitr::include_graphics("example/example_dag1.pdf")
```

\only<1>{
\large
\begin{itemize}
\item Estimtae $\mathbb{E}\!\left[Y_{i}^{(0)}|C_{i1},C_{i2}\right]$ for $X_{i}=1$ to compare with $\mathbb{E}\!\left[Y_{i}|X_{i}=1\right]$
\item Estimtae $\mathbb{E}\!\left[Y_{i}^{(1)}|C_{i1},C_{i2}\right]$ for $X_{i}=0$ to compare with $\mathbb{E}\!\left[Y_{i}|X_{i}=0\right]$
\end{itemize}
}


```{r}
.dt <- sim.example1()
cc <- cbind(.dt$c1, .dt$c2)
x <- .dt$x
yy1 <- .dt$y[x == 1]
yy0 <- .dt$y[x == 0]
cc1 <- cc[x == 1, ]
cc0 <- cc[x == 0, ]

## match x=1 -> x=0
.out.1 <- FNN::get.knnx(cc0, cc1, k=1)
## match x=0 -> x=1
.out.0 <- FNN::get.knnx(cc1, cc0, k=1)
```

```{r}
.dt.matched <- 
    rbind(data.table(obs=cc1, matched=cc0[.out.1$nn.index,], x = 1),
          data.table(obs=cc0, matched=cc1[.out.0$nn.index,], x = 0)) %>% 
    cbind(data.table(y0=c(yy0[.out.1$nn.index], yy0),
                     y1=c(yy1, yy1[.out.0$nn.index])))
```

```{r fig.width=6, fig.height=3, only.plot="2"}
ggplot(.dt.matched, aes(obs.V1, obs.V2)) +
    geom_point(aes(fill=factor(x, c(0,1))), pch=21) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("C1") + ylab("C2")
```

```{r fig.width=6, fig.height=3, only.plot="3"}
ggplot(.dt.matched, aes(obs.V1, obs.V2, xend=matched.V1, yend=matched.V2)) +
    geom_segment(size=.5, lty=2, colour="magenta") +
    geom_point(aes(fill=factor(x, c(0,1))), pch=21) +
    scale_fill_brewer(palette="Set3", guide="none") +
    xlab("C1") + ylab("C2")
```

```{r fig.width=6, fig.height=2.8, only.plot="4"}
p1 <-
    ggplot(.dt, aes(as.factor(x), y, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ggpubr::stat_compare_means(vjust=1, color="blue", size=2) +
    xlab("exposure/treatment") +
    ylab("observed outcome\nY|X=1 vs. Y|X=0")

p2 <-
    ggplot(.dt.matched, aes(as.factor(x), y1-y0, fill=as.factor(x))) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ggpubr::stat_compare_means(vjust=1, color="blue", size=2) +
    xlab("exposure/treatment") +
    ylab("matched & adjusted outcome\nY(do(X=1)) - Y(do(X=0))")

p1|p2
```

## Bayesian Additive Regression Tree (BART) approach

\large

- G-formula $\to$ outcome regression models

- Regression model for $Y \sim S$ for each $X=1$ and $X=0$ using BART

\begin{eqnarray*}
\mathbb{E}\!\left[Y^{(1)}\right] 
	&=& \int_{S} {\color{magenta} \mathbb{E}\!\left[Y \middle| X=1, S\right]} dS \\
\mathbb{E}\!\left[Y^{(0)}\right] &=& \int_S {\color{magenta} \mathbb{E}\!\left[Y \middle| X=0, S\right] }dS
\end{eqnarray*}

- Estimate causal effect: $\mathbb{E}\!\left[Y^{(1)}\right] - \mathbb{E}\!\left[Y^{(0)}\right]$

\tiny

Hill, *Bayesian Nonparametric Modeling for Causal Inference* (2011)

```{r}
run.bart <- function(yy, xx, covar){
    y1 <- yy[xx == 1]
    covar1 <- covar[xx == 1, , drop = FALSE]
    y0 <- yy[xx == 0]
    covar0 <- covar[xx == 0, , drop = FALSE]
    bart.out <- BART::wbart(covar, yy)
    
    y.imp.0 <- predict(bart.out, covar[xx == 0, , drop = FALSE])
    y.imp.1 <- predict(bart.out, covar[xx == 1, , drop = FALSE])

    .dt <- rbind(data.table(y.obs = yy[xx == 0],
                            y.imp = apply(y.imp.0, 2, mean),
                            y.imp.sd = apply(y.imp.0, 2, sd),
                            x = 0),
                 data.table(y.obs = yy[xx == 1],
                            y.imp = apply(y.imp.1, 2, mean),
                            y.imp.sd = apply(y.imp.1, 2, sd),
                            x = 1)) %>%
        arrange(y.imp) %>%
        mutate(x = factor(x, c(0, 1), c("control", "case"))) %>% 
        mutate(i = 1:n())
}
```

```{r}
plot.bart <- function(.dt) {
    ggplot(.dt, aes(x=i, y=y.obs, group=x)) +
        xlab("data points") + ylab("outcome") +
        facet_grid(.~x) +
        geom_segment(aes(xend=i, y=y.imp, yend=y.obs, color=x),
                       arrow=arrow(type="closed", length=unit(.2,"lines")), size=.2, alpha=.5) +
        geom_point(aes(y=y.imp), size = .2, color="gray40") +
        geom_point(aes(fill=`x`), pch=21, alpha=.5, size=.5) +
        geom_smooth(aes(y = y.imp + y.imp.sd, color=x), size=.4,
                    lty = 2, se = FALSE) +
        geom_smooth(aes(y = y.imp - y.imp.sd, color=x), size=.4,
                    lty = 2, se = FALSE) +
        scale_fill_manual(values=c("#009900","magenta"))+
        scale_color_manual(values=c("#009900","magenta"))+
        theme(legend.position = c(0.1,1), legend.justification = c(0,1))
}
```

## The same example with causal relationship from $X$ to $Y$

```{r fig.width=1.5, fig.height=3, results="asis"}
knitr::include_graphics("example/example_dag1_open.pdf")
```

## BART: a regression model to impute potential outcomes

```{r include=FALSE}
.bart <- run.bart(.dt$y, .dt$x, cbind(.dt$c1, .dt$c2))
```

```{r fig.width=6, fig.height=2.8, only.plot="1", echo=FALSE}
plot.bart(.bart)
```

```{r fig.width=6, fig.height=2.8, only.plot="2"}
p1 <-
    ggplot(.bart, aes(x, y.obs, fill=x)) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ggpubr::stat_compare_means(vjust=1, color="blue", size=2) +
    xlab("exposure/treatment") +
    ylab("observed outcome\nY|X=1 vs. Y|X=0")

p2 <-
    ggplot(.bart, aes(x, y.obs-y.imp, fill=x)) +
    geom_violin() +
    geom_boxplot(fill="white", outlier.size=0, outlier.stroke=0, width=.2) +
    scale_fill_brewer(palette="Set3", guide="none") +
    ggpubr::stat_compare_means(vjust=1, color="blue", size=2) +
    xlab("exposure/treatment") +
    ylab("adjusted outcome\nY(do(X=1)) - Y(do(X=0))")

p1|p2
```

